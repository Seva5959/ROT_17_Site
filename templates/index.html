{% extends "base.html" %}

{% block title %}–†–∞–∑–≥–∞–¥–∞–π –∫–æ–¥{% endblock %}

{% block content %}
<div class="container">
    <h1>–ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑–≥–∞–¥–∞–Ω–Ω—ã–π —à–∏—Ñ—Ä!</h1>

    <!-- –ë–ª–æ–∫ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—Å–µ —Ä–µ—à–µ–Ω–æ) -->
    {% if all_solved %}
    <div class="congratulations-container" id="congratsContainer" style="display: none; opacity: 0;">
        <div class="congratulations-card">
            <div class="confetti-container">
                {% for _ in range(10) %}<div class="confetti"></div>{% endfor %}
            </div>
            <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ</h2>
            <p>–í—ã —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≥–∞–¥–∞–ª–∏ –≤—Å–µ —à–∏—Ñ—Ä—ã!</p>
            <div class="full-link-container">
                <p>–í–æ—Ç –ø–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞:</p>
                <div class="full-link-box">
                    <input type="text" id="fullLink" value="{{ full_link }}" readonly>
                    <button onclick="copyToClipboard('fullLink')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <span class="copy-success-message" style="display:none;">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!</span>
            </div>
            <button class="close-btn" onclick="toggleCongrats(false)">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    {% endif %}

    <div class="grid">
        {% for code in codes %}
            <div class="card {{ 'solved' if code.solved }}">
                <span class="card-number">{{ code.roman_number }}</span>

                {% if code.solved %}
                    <div class="success-message">‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≥–∞–¥–∞–Ω–æ!</div>
                    <button class="toggle-btn">‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                    <div class="answer-block">
                        <input type="text"
                               value="{{ answers[code.number] }}"
                               id="answer-{{ code.id }}"
                               readonly>
                        <button class="copy-btn" onclick="copyToClipboard('answer-{{ code.id }}')">
                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                {% else %}
                    <form method="POST" action="{{ url_for('check', code_id=code.id) }}">
                        <input type="text"
                               name="decoded_text"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"
                               required>
                        <button type="submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!-- –ë–ª–æ–∫ —Å –ø–æ–ª–Ω–æ–π —Å—Å—ã–ª–∫–æ–π (—Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—Å–µ —Ä–µ—à–µ–Ω–æ) -->
    {% if all_solved %}
    <div class="complete-link-section">
        <h3>–ü–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞:</h3>
        <div class="full-link-box">
            <input type="text" id="permanentLink" value="{{ full_link }}" readonly>
            <button onclick="copyToClipboard('permanentLink')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <span class="copy-success-message" id="permanentLinkSuccess" style="display:none;">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!</span>
        <button class="show-congrats-btn" onclick="toggleCongrats(true)">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    let notification;
    if (elementId === 'permanentLink') {
        notification = document.getElementById('permanentLinkSuccess');
    } else {
        const parent = element.closest('.full-link-box, .answer-block');
        notification = parent.nextElementSibling || parent.querySelector('.copy-success-message');
    }

    if (notification) {
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 2000);
    }
}

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
function toggleCongrats(show) {
    const container = document.getElementById('congratsContainer');
    if (container) {
        if (show) {
            container.style.display = 'flex';
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                container.style.opacity = '1';
            }, 10);
        } else {
            container.style.opacity = '0';
            setTimeout(() => {
                container.style.display = 'none';
            }, 500);
        }
    }
}

// –ê–≤—Ç–æ–ø–æ–∫–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –µ—Å–ª–∏ –≤—Å–µ —Ä–µ—à–µ–Ω–æ
document.addEventListener('DOMContentLoaded', function() {
    {% if all_solved %}
    setTimeout(() => toggleCongrats(true), 500);
    {% endif %}

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö
    document.querySelectorAll('.copy-btn').forEach(btn => {
        if (!btn.onclick) {
            const inputId = btn.closest('.answer-block').querySelector('input').id;
            btn.addEventListener('click', () => copyToClipboard(inputId));
        }
    });
});
</script>
{% endblock %}